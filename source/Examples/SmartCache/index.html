<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="SmartCache Example This SmartCache example is a C&#43;&#43; implementation of the Python SmartCache.
It implements a simple cache with different replacement policies and cache size as built-in tunables and some simple workloads.
It can be used to demonstrate a full end-to-end MLOS integrated microbenchmark for a &ldquo;smart&rdquo; component (in this case a cache).
Overview To do that, we run the (C&#43;&#43;) SmartCache executable to communicate with the (C#) Mlos.Agent.Server over a shared memory channel provided by the Mlos.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://microsoft.github.io/MLOS/source/Examples/SmartCache/" />

<title>Smart Cache | MLOS</title>
<link rel="manifest" href="/MLOS/manifest.json">
<link rel="icon" href="/MLOS/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/MLOS/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/MLOS/en.search.min.9d3d826a74a238923dfb862edd7dd7495c7867e2bd880c50b9c513f2a94d39b1.js" integrity="sha256-nT2CanSiOJI9&#43;4Yu3X3XSVx4Z&#43;K9iAxQucUT8qlNObE="></script>
<link rel="alternate" type="application/rss+xml" href="https://microsoft.github.io/MLOS/source/Examples/SmartCache/index.xml" title="MLOS" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/MLOS"><span>MLOS</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
<p><a href="/MLOS/documentation/">Documentation</a></p>
<ul>
<li><a href="/MLOS/documentation/01-Prerequisites/">Prerequisites</a></li>
<li><a href="/MLOS/documentation/02-Build/">Build</a></li>
<li><a href="/MLOS/documentation/04-Test/">Test</a></li>
<li><a href="/MLOS/documentation/CodingStandard/">Coding Standard</a></li>
<li><a href="/MLOS/documentation/MlosArchitecture/">Architecture</a></li>
<li><a href="/MLOS/documentation/RepoOrganization/">Repo Organization</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/notebooks/">Notebooks</a></p>
<ul>
<li><a href="/MLOS/notebooks/BayesianOptimization/">Bayesian Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheOptimization/">Smart Cache Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheCPP/">Smart Cache Optimization in C++</a></li>
<li><a href="/MLOS/notebooks/LevelDbTuning/">LevelDB External Tuning Example</a></li>
</ul>
</li>
<li>
<p>API Documentation</p>
<ul>
<li><a href="/MLOS/python_api/">Python</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/source/Examples/">E2E Examples</a></p>
<ul>
<li><a href="/MLOS/source/Examples/SmartCache/"class=active>Smart Cache</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/CODE_OF_CONDUCT/">Code of Conduct</a></p>
</li>
<li>
<p><a href="/MLOS/CONTRIBUTING/">Contributing</a></p>
</li>
<li>
<p><a href="https://github.com/Microsoft/MLOS">MLOS Github Repository</a></p>
</li>
</ul>










</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/MLOS/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Smart Cache</strong>

  <label for="toc-control">
    
    <img src="/MLOS/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#building">Building</a></li>
    <li><a href="#executing">Executing</a>
      <ul>
        <li><a href="#explanation">Explanation</a></li>
      </ul>
    </li>
    <li><a href="#caveats">Caveats</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="smartcache-examplehttpsgithubcommicrosoftmlostreemainsourceexamplessmartcache"><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/">SmartCache Example</a></h1>
<p>This <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/"><code>SmartCache</code></a> example is a C++ implementation of the <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Python/mlos/Examples/SmartCache/">Python SmartCache</a>.</p>
<p>It implements a simple cache with different replacement policies and cache size as built-in tunables and some simple workloads.</p>
<p>It can be used to demonstrate a full end-to-end MLOS integrated microbenchmark for a &ldquo;smart&rdquo; component (in this case a cache).</p>
<h2 id="overview">Overview</h2>
<p>To do that, we run the (C++) <code>SmartCache</code> executable to communicate with the (C#) <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Agent.Server/"><code>Mlos.Agent.Server</code></a> over a shared memory channel provided by the <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Core/"><code>Mlos.Core</code></a> library.</p>
<p>The <code>Mlos.Agent.Server</code> is essentially a small wrapper around several other communication channels to allow different components to connect for component experimentation convenience.</p>
<p>It provides</p>
<ol>
<li>
<p>Shared memory communication channels via the <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Agent/"><code>Mlos.Agent</code></a> and <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.NetCore/"><code>Mlos.NetCore</code></a> libraries.</p>
</li>
<li>
<p>A <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Agent.GrpcClient/"><code>Mlos.Agent.GrpcServer</code></a> GRPC channel to allow driving the experimentation process from a Jupyter notebook.</p>
</li>
<li>
<p>A GRPC client to connect to the (Python) <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Python/mlos/Grpc/OptimizerMicroserviceServer.py"><code>mlos.Grpc.OptimizerMicroserviceServer</code></a> to store and track those experiments.</p>
</li>
</ol>
<p>TODO: Diagrams</p>
<h2 id="building">Building</h2>
<blockquote>
<p>Note: these commands are given relative to the root of the MLOS repo.</p>
<p>To move there, you can execute the following within the repository:</p>
<p><code>cd $(git rev-parse --show-toplevel)</code></p>
</blockquote>
<p>To build and run the necessary components for this example</p>
<ol>
<li>
<p><a href="/MLOS/source/Examples/SmartCache/../../../documentation/01-Prerequisites/#build-the-docker-image">Pull or build the Docker image</a> using the <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../../Dockerfile"><code>Dockerfile</code></a> at the root of the repository.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker build . --build-arg<span style="color:#f92672">=</span>UbuntuVersion<span style="color:#f92672">=</span>20.04 -t mlos-build-ubuntu-20.04 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cache-from ghcr.io/microsoft-cisl/mlos/mlos-build-ubuntu-20.04
</code></pre></div></li>
<li>
<p><a href="/MLOS/source/Examples/SmartCache/../../../documentation/02-Build/#create-a-new-container-instance">Run the Docker image</a> you just built.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker run -it -v $PWD:/src/MLOS -P --name mlos-build mlos-build-ubuntu-20.04
</code></pre></div></li>
<li>
<p>Inside the container, <a href="/MLOS/source/Examples/SmartCache/../../../documentation/02-Build/#cli-make">build the compiled software</a> with <code>make</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">make all install
</code></pre></div><blockquote>
<p>This will build everything using a default <code>CONFIGURATION=Release</code>.</p>
<p>To just build <code>SmartCache</code> and <code>Mlos.Agent.Server</code>, execute the following:</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># Alternatively:</span>
make -C source/Mlos.Agent.Server
make -C source/Examples/SmartCache all install
</code></pre></div></li>
<li>
<p>For a <code>Release</code> build (the default), the relevant output will be installed at:</p>
<ul>
<li>
<p>Mlos.Agent.Server:</p>
<p><code>target/bin/Release/AnyCPU/Mlos.Agent.Server/Mlos.Agent.Server.dll</code></p>
</li>
<li>
<p>SmartCache:</p>
<p><code>target/bin/Release/x86_64/SmartCache</code></p>
</li>
<li>
<p>SmartCache.SettingsRegistry:</p>
<p><code>target/bin/Release/AnyCPU/SmartCache.SettingsRegistry.dll</code></p>
</li>
</ul>
</li>
</ol>
<h2 id="executing">Executing</h2>
<p>The following commands will start the <code>Mlos.Server.Agent</code> and cause it to start the <code>SmartCache</code> component microbenchmark:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">tools/bin/dotnet target/bin/Release/AnyCPU/Mlos.Agent.Server/Mlos.Agent.Server.dll <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --executable target/bin/Release/x86_64/SmartCache <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --settings-registry-path target/bin/Release/AnyCPU
    --optimizer-uri http://localhost:50051
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">Mlos.Agent.Server
Starting target/bin/Release/x86_64/SmartCache
observations: 0
warn: Microsoft.AspNetCore.Server.Kestrel[0]
      Unable to bind to http://localhost:5000 on the IPv6 loopback interface: &#39;Cannot assign requested address&#39;.
info: Microsoft.Hosting.Lifetime[0]
      Now listening on: http://localhost:5000
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /src/MLOS
Starting Mlos.Agent
Found settings registry assembly at target/bin/Release/AnyCPU/SmartCache.SettingsRegistry.dll
observations: 1
observations: 2
observations: 3
...
</code></pre></div><h3 id="explanation">Explanation</h3>
<p>The <code>Mlos.Agent</code> that gets started by the <code>Mlos.Agent.Server</code> waits for a signal that the component (<code>SmartCache</code>) has connected to the shared memory region before starting to poll the component for messages to process.
This is important in case the component is started independently.</p>
<p>In this case, <code>Mlos.Agent.Server</code> itself starts the component.</p>
<p>Once started, <code>SmartCache</code> will attempt to register its component specific set of shared memory messages with the <code>Mlos.Agent</code> in the <code>Mlos.Agent.Server</code> using <code>RegisterComponentConfig</code> and <code>RegisterAssemblyRequestMessage</code> from <code>Mlos.Core</code> and <code>Mlos.NetCore</code>.
That includes the name of the <code>SettingsRegistry</code> assembly (<code>.dll</code>) corresponding to that component&rsquo;s settings/messages.</p>
<p>The <code>Mlos.Agent.Server</code> needs to be told where it can find those assemblies in order to load them so that it can process the messages sent by the component.
To do that, we use the <code>--settings-registry-path</code> option.</p>
<p>We also tell the <code>Mlos.Agent.Server</code> how to connect to the (Python) MLOS Optimizer Service over GRPC so that the application message handlers setup by the <code>SmartCache.SettingsRegistry</code> for the agent can request new configuration recommendations on behave of the application.</p>
<p>For additional details please see the comments in the following code files:</p>
<ul>
<li><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Agent.Server/MlosAgentServer.cs">Mlos.Agent.Server/MlosAgentServer.cs</a></li>
<li><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/Main.cpp">SmartCache/Main.cpp</a></li>
<li><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/SmartCache.SettingsRegistry/AssemblyInitializer.cs">SmartCache.SettingsRegistry/AssemblyInitializer.cs</a></li>
<li><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/SmartCache.SettingsRegistry/Codegen/SmartCache.cs">SmartCache.SettingsRegistry/Codegen/SmartCache.cs</a></li>
</ul>
<h2 id="caveats">Caveats</h2>
<ul>
<li>
<p>The system currently only supports one shared memory region and doesn&rsquo;t cleanup the shared memory after itself.</p>
<p>As such, you may see hung processes when restarting after a failed experiment.</p>
<p>To help with this, we currently provide a helper script to remove previous incarnations of the shared memory regions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">build/CMakeHelpers/RemoveMlosSharedMemories.sh
</code></pre></div><p>You may also need to make sure that the processes using them are killed off.
For instance:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">pkill SmartCache
pkill -f dotnet.*Mlos.Agent.Server.dll
</code></pre></div><blockquote>
<p>Note: each of these commands should be executed inside the <code>Mlos.Agent.Server</code> execution environment (e.g. inside the docker container).</p>
</blockquote>
</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#building">Building</a></li>
    <li><a href="#executing">Executing</a>
      <ul>
        <li><a href="#explanation">Explanation</a></li>
      </ul>
    </li>
    <li><a href="#caveats">Caveats</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












